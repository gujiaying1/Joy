@using JoyRiseFitness.Models
@model IEnumerable<Equipment>
@{
    ViewBag.Title = "Equipment Tutorial";
    int page = ViewBag.Page;
    int maxPage = ViewBag.MaxPage;
}

<section class="eq-list glass reveal">
    <h2 class="reveal">Find Your Perfect Move</h2>

    <form method="get" class="filter-bar reveal">
        <input type="text" name="q" placeholder="Search equipment…" value="@ViewBag.Query" />
        <select name="part">
            <option value="">All Parts</option>
            @foreach (MusclePart mp in Enum.GetValues(typeof(MusclePart)))
            {
                <option value="@mp" selected="@(mp==ViewBag.Part)">@mp</option>
            }
        </select>
        <select name="sort">
            <option value="">Default</option>
            <option value="diff-asc" selected="@(ViewBag.Sort=="diff-asc")">Difficulty ↑</option>
            <option value="diff-desc" selected="@(ViewBag.Sort=="diff-desc")">Difficulty ↓</option>
        </select>
        <button type="submit">Filter</button>
    </form>

    <div class="cards">
        @{int i = 0;}
        @foreach (var item in Model)
        {
            <div class="card reveal" data-id="@item.Id" style="animation-delay:@(i++*80)ms">
                <img src="@item.ImgUrl" alt="@item.Name" />
                <h3>@item.Name</h3>
                <p class="part">@item.Part · @item.Difficulty</p>
                <p class="desc">@item.ShortDesc</p>
                <div class="foot">
                    <!-- 这里的item在循环内是有效的 -->
                    <a href="@Url.Action("Detail", "Equipment", new { id = item.Id })" class="btn">Detail</a>
                    <!-- 修改这里的onclick调用 -->
                    <span class="heart" onclick="addToWorkoutPlan(@item.Id, this)">❤</span>
                </div>
            </div>
        }
    </div>

    <!-- 分页 -->
    @if (maxPage > 1)
    {
        <div class="paging">
            @for (int np = 1; np <= maxPage; np++)
            {
                <a class="@(np==page?"on":"")"
                   href="@Url.Action("Index", new { q = ViewBag.Query, part = ViewBag.Part, sort = ViewBag.Sort, p = np })">@np</a>
            }
        </div>
    }
</section>

<!-- 添加防伪令牌 -->
@Html.AntiForgeryToken()

<script src="@Url.Content("~/Scripts/favorite.js")"></script>
<script>
    // 添加到训练计划函数
    function addToWorkoutPlan(equipmentId, element) {
        // 获取设备名称
        const card = element.closest('.card');
        const equipmentName = card.querySelector('h3').textContent;

        // 获取防伪令牌
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        // 发送AJAX请求
        fetch('@Url.Action("AddToWorkoutPlan", "Generator")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                equipmentId: equipmentId,
                equipmentName: equipmentName
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            if (data.success) {
                // 更新爱心样式
                element.classList.add('on');
                element.style.color = '#e91e63';

                // 保存到localStorage
                localStorage.setItem(`plan_${equipmentId}`, 'true');

                // 显示成功通知
                showToast(`"${equipmentName}" added to My Plan!`);
            } else {
                showToast(data.message || 'Failed to add to plan', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to save. Please try again.', 'error');
        });
    }

    // 显示Toast通知
    function showToast(message, type = 'success') {
        // 移除现有toast
        const existingToast = document.querySelector('.custom-toast');
        if (existingToast) {
            existingToast.remove();
        }

        // 创建新toast
        const toast = document.createElement('div');
        toast.className = `custom-toast ${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;

        // 添加样式
        toast.style.cssText = `
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: ${type === 'success' ? '#34c759' : '#ff3b30'};
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 10000;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideInUp 0.3s ease;
            max-width: 300px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
        `;

        document.body.appendChild(toast);

        // 3秒后移除
        setTimeout(() => {
            toast.style.animation = 'slideOutDown 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // 页面加载时检查哪些设备已在计划中
    document.addEventListener('DOMContentLoaded', function() {
        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes slideInUp {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @@keyframes slideOutDown {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(100%); opacity: 0; }
            }
            .heart {
                cursor: pointer;
                font-size: 1.3rem;
                color: #ccc;
                transition: color 0.3s, transform 0.3s;
            }
            .heart:hover {
                transform: scale(1.2);
            }
            .heart.on {
                color: #e91e63 !important;
                animation: heartBeat 0.5s;
            }
            @@keyframes heartBeat {
                0% { transform: scale(1); }
                25% { transform: scale(1.3); }
                50% { transform: scale(1); }
                75% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // 检查localStorage的收藏状态
        document.querySelectorAll('.card').forEach(card => {
            const equipmentId = card.getAttribute('data-id');
            const heart = card.querySelector('.heart');
            if (localStorage.getItem(`plan_${equipmentId}`)) {
                heart.classList.add('on');
                heart.style.color = '#e91e63';
            }
        });
    });

    window.addEventListener('load', () => document.querySelectorAll('.reveal').forEach(e => e.classList.add('visible')));
</script>