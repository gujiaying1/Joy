﻿@using JoyRiseFitness.Models
@model IEnumerable<Equipment>
@{
    ViewBag.Title = "Equipment Tutorial";
    int page = ViewBag.Page;
    int maxPage = ViewBag.MaxPage;
}

<section class="eq-list glass reveal">
    <h2 class="reveal">Find Your Perfect Move</h2>

    <form method="get" class="filter-bar reveal">
        <input type="text" name="q" placeholder="Search equipment…" value="@ViewBag.Query" />
        <select name="part">
            <option value="">All Parts</option>
            @foreach (MusclePart mp in Enum.GetValues(typeof(MusclePart)))
            {
                <option value="@mp" selected="@(mp==ViewBag.Part)">@mp</option>
            }
        </select>
        <select name="sort">
            <option value="">Default</option>
            <option value="diff-asc" selected="@(ViewBag.Sort=="diff-asc")">Difficulty ↑</option>
            <option value="diff-desc" selected="@(ViewBag.Sort=="diff-desc")">Difficulty ↓</option>
        </select>
        <button type="submit">Filter</button>
    </form>

    <div class="cards">
        @{int i = 0;}
        @foreach (var item in Model)
        {
            <div class="card reveal" data-id="@item.Id" style="animation-delay:@(i++*80)ms">
                <img src="@item.ImgUrl" alt="@item.Name" />
                <h3>@item.Name</h3>
                <p class="part">@item.Part · @item.Difficulty</p>
                <p class="desc">@item.ShortDesc</p>
                <div class="foot">
                    <!-- 这里的item在循环内是有效的 -->
                    <a href="@Url.Action("Detail", "Equipment", new { id = item.Id })" class="btn">Detail</a>
                    <!-- 修改这里的onclick调用 -->
                    <span class="heart" onclick="addToWorkoutPlan(@item.Id, this)">❤</span>
                </div>
            </div>
        }
    </div>

    <!-- 分页 -->
    @if (maxPage > 1)
    {
        <div class="paging">
            @for (int np = 1; np <= maxPage; np++)
            {
                <a class="@(np==page?"on":"")"
                   href="@Url.Action("Index", new { q = ViewBag.Query, part = ViewBag.Part, sort = ViewBag.Sort, p = np })">@np</a>
            }
        </div>
    }
</section>

<!-- 添加防伪令牌 -->
@Html.AntiForgeryToken()

<script src="@Url.Content("~/Scripts/favorite.js")"></script>
<script>
    // 全局变量存储计划状态
    let planStatus = {};

    // 页面加载时检查所有设备是否在计划中
    document.addEventListener('DOMContentLoaded', function() {
        // 添加CSS样式
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes slideInUp {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @@keyframes slideOutDown {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(100%); opacity: 0; }
            }
            .heart {
                cursor: pointer;
                font-size: 1.3rem;
                color: #ccc;
                transition: color 0.3s, transform 0.3s;
                display: inline-block;
            }
            .heart:hover {
                transform: scale(1.2);
            }
            .heart.on {
                color: #e91e63 !important;
                animation: heartBeat 0.5s;
            }
            @@keyframes heartBeat {
                0% { transform: scale(1); }
                25% { transform: scale(1.3); }
                50% { transform: scale(1); }
                75% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // 为每个卡片检查计划状态
        document.querySelectorAll('.card').forEach(card => {
            const equipmentId = card.getAttribute('data-id');
            const heart = card.querySelector('.heart');

            // 初始检查计划状态
            checkPlanStatus(equipmentId, heart);
        });
    });

    // 检查设备是否在计划中
    function checkPlanStatus(equipmentId, heartElement) {
        fetch('@Url.Action("CheckInPlan", "Generator")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ id: equipmentId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                planStatus[equipmentId] = data.isInPlan;

                if (data.isInPlan) {
                    heartElement.classList.add('on');
                    heartElement.style.color = '#e91e63';
                    heartElement.title = 'Remove from My Plan';
                    // 同步本地存储
                    localStorage.setItem(`plan_${equipmentId}`, 'true');
                } else {
                    heartElement.classList.remove('on');
                    heartElement.style.color = '';
                    heartElement.title = 'Add to My Plan';
                    localStorage.removeItem(`plan_${equipmentId}`);
                }
            }
        })
        .catch(error => {
            console.error('Error checking plan status:', error);
            // 如果API失败，使用本地存储作为备选
            const localStatus = localStorage.getItem(`plan_${equipmentId}`);
            if (localStatus === 'true') {
                heartElement.classList.add('on');
                heartElement.style.color = '#e91e63';
            }
        });
    }

    // 切换训练计划状态（添加/移除）
    function addToWorkoutPlan(equipmentId, element) {
        const card = element.closest('.card');
        const equipmentName = card.querySelector('h3').textContent;
        const isCurrentlyInPlan = planStatus[equipmentId] || false;

        if (isCurrentlyInPlan) {
            // 如果已经在计划中，则移除
            removeFromPlan(equipmentId, element, equipmentName);
        } else {
            // 如果不在计划中，则添加
            addToPlan(equipmentId, element, equipmentName);
        }
    }

    // 添加到计划
    function addToPlan(equipmentId, heartElement, equipmentName) {
        // 显示加载状态
        const originalHTML = heartElement.innerHTML;
        heartElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        heartElement.style.pointerEvents = 'none';

        fetch('@Url.Action("AddToWorkoutPlan", "Generator")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                equipmentId: equipmentId,
                equipmentName: equipmentName
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            if (data.success) {
                // 更新状态
                planStatus[equipmentId] = true;
                heartElement.classList.add('on');
                heartElement.style.color = '#e91e63';
                heartElement.title = 'Remove from My Plan';

                // 保存到本地存储
                localStorage.setItem(`plan_${equipmentId}`, 'true');

                // 显示成功通知
                showToast(`"${equipmentName}" added to My Plan!`);

                // 触发心跳动画
                heartElement.style.animation = 'none';
                setTimeout(() => {
                    heartElement.style.animation = 'heartBeat 0.5s';
                }, 10);
            } else {
                showToast(data.message || 'Failed to add to plan', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to save. Please try again.', 'error');
        })
        .finally(() => {
            // 恢复按钮状态
            heartElement.innerHTML = '❤';
            heartElement.style.pointerEvents = 'auto';
        });
    }

    // 从计划中移除
    function removeFromPlan(equipmentId, heartElement, equipmentName) {
        if (!confirm(`Remove "${equipmentName}" from your plan?`)) {
            return;
        }

        // 显示加载状态
        const originalHTML = heartElement.innerHTML;
        heartElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        heartElement.style.pointerEvents = 'none';

        fetch('@Url.Action("RemoveFromPlan", "Generator")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ id: equipmentId })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            if (data.ok) {
                // 更新状态
                planStatus[equipmentId] = false;
                heartElement.classList.remove('on');
                heartElement.style.color = '';
                heartElement.title = 'Add to My Plan';

                // 从本地存储移除
                localStorage.removeItem(`plan_${equipmentId}`);

                // 显示成功通知
                showToast(`"${equipmentName}" removed from My Plan`);
            } else {
                showToast('Failed to remove from plan', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to remove. Please try again.', 'error');
        })
        .finally(() => {
            // 恢复按钮状态
            heartElement.innerHTML = '❤';
            heartElement.style.pointerEvents = 'auto';
        });
    }

    // 显示Toast通知
    function showToast(message, type = 'success') {
        // 移除现有toast
        const existingToast = document.querySelector('.custom-toast');
        if (existingToast) {
            existingToast.remove();
        }

        // 创建新toast
        const toast = document.createElement('div');
        toast.className = `custom-toast ${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;

        // 添加样式
        toast.style.cssText = `
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: ${type === 'success' ? '#34c759' : '#ff3b30'};
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 10000;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideInUp 0.3s ease;
            max-width: 300px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        `;

        document.body.appendChild(toast);

        // 3秒后移除
        setTimeout(() => {
            toast.style.animation = 'slideOutDown 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // 保持现有的滚动动画
    window.addEventListener('load', () => {
        document.querySelectorAll('.reveal').forEach(e => e.classList.add('visible'));

        // 添加字体图标
        if (!document.querySelector('#font-awesome')) {
            const link = document.createElement('link');
            link.id = 'font-awesome';
            link.rel = 'stylesheet';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
            document.head.appendChild(link);
        }
    });
</script>